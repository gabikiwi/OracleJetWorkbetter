/**
 * Copyright (c) 2014, 2017, Oracle and/or its affiliates.
 * The Universal Permissive License (UPL), Version 1.0
 */
"use strict";
define(["ojs/ojcore","knockout","promise"],function(a,g){a.$z={};a.$z.sd={viewPath:"text!views/",viewSuffix:".html",modelPath:"viewModels/",initializeMethod:"initialize",disposeMethod:"dispose",activatedHandler:"handleActivated",attachedHandler:"handleAttached",detachedHandler:"handleDetached",bindingsAppliedHandler:"handleBindingsApplied",deactivatedHandler:"handleDeactivated",transitionCompletedHandler:"handleTransitionCompleted"};o_("ModuleBinding.defaults",a.$z.sd,a);(function(){function c(b,
c,e,f,h,k,l){var n=c.canAnimate;if(null==n||n.call(c,b)){var r,t;if(n=c.prepareAnimation.call(c,b))r=n.newViewParent,t=n.oldViewParent;var B=r||e;t&&t!==e?d(f,t):B===e&&k(null);B!==e&&g.virtualElements.setDomNodeChildren(B,[]);h(B);var J=Array.prototype.slice.call(B.childNodes),F=!1,K=function(){F||(F=!0,e!==B&&(m(e,J),a.Components&&(p(J,a.Components.ig),p(J,a.Components.hf))))},C=k.bind(null,t);b.newViewParent=r;b.oldViewParent=t;b.oldViewNodes=f;b.removeOldView=C;b.insertNewView=K;var I=function(){C();
K();l()};return c.animate.call(c,b).then(I,function(){I();a.F.error("ojModule animation promise was rejected")})}}function b(a,b,c){b=b||a;var d=[];c&&a===b&&(c.parentNode.removeChild(c),d.push(c));g.virtualElements.setDomNodeChildren(b,d)}function d(a,b){a.forEach(function(a){b.appendChild(a)})}function e(a,b,c){if(a&&a[b]){var d={element:c[0],valueAccessor:c[1]};2<c.length&&(d.viewModel=c[2],3<c.length&&(d["boolean"===typeof c[3]?"fromCache":"cachedNodes"]=c[3]));return g.ignoreDependencies(a[b],
a,[d])}}function f(b,c,d){if(null!=b&&(c=a.$z.sd[c],null!=c&&b&&(c=b[c],"function"===typeof c))){var e=void 0;d&&(e={element:d[0],valueAccessor:d[1]},2<d.length&&(e["boolean"===typeof d[2]?"fromCache":"cachedNodes"]=d[2]));return g.ignoreDependencies(c,b,[e])}}function h(a,b,c){var d=[];for(a=g.virtualElements.firstChild(a);null!=a&&a!=c;a=a.nextSibling)a!=b&&d.push(a);return d}function k(a,b){var c=[],d=g.virtualElements.firstChild(a);l(d,b,function(a){c.push(a)});return c}function l(a,b,c){for(;null!=
a;){var d=g.virtualElements.nextSibling(a),e=a.nodeType;a===b||1!==e&&8!==e||c(a);a=d}}function m(a,b){for(var c=b.length-1;0<=c;c--)g.virtualElements.prepend(a,b[c])}function p(a,b){if(b)for(var c=0;c<a.length;c++)b(a[c])}function t(a,b){if("string"===typeof a)a=g.utils.parseHtmlFragment(a);else if(window.DocumentFragment?a instanceof DocumentFragment:a&&11===a.nodeType)a=g.utils.arrayPushAll([],a.childNodes);else if(Array.isArray(a))a=g.utils.arrayPushAll([],a);else throw b(),"The View ("+a+") has an unsupported type";
return a}function r(b){return new Promise(function(c,d){require([b],function(a){c(a)},function(c){a.F.error("ojModule failed to load "+b);d(c)})})}function n(a){return a?new Promise(function(b){a.then(b,b)}):a}g.bindingHandlers.ojModule={init:function(s,q,u,v,w){function x(a){if(a!=F)throw E;}function y(a){f(a,"disposeMethod",[s,q])}function z(){I&&(I(),I=null)}var A,D,B={},J,F=-1,K,C,I;g.utils.domNodeDisposal.addDisposeCallback(s,function(){y(A);for(var a=Object.keys(B),b=0;b<a.length;b++)y(B[a[b]].En);
z()});var E=Error("Promise cancelled because ojModule is fetching new View and ViewModel"),N=s;8===s.nodeType&&(N=s.parentElement,g.virtualElements.setDomNodeChildren(s,[]),C=s.nextSibling);g.computed(function(){F++;I||(I=a.Context.getContext(N).Mj().Jj({description:"ojModule binding on a node with the Id "+s.id+"is loading the module. Binding evaluator: "+q.toString()}));var u=0===F,v=g.utils.unwrapObservable,P=v(q()),R,V,Z,fa,ca,S,ga,U;"string"===typeof P?R=P:(R=v(P.name),V=v(P.viewName),Z=v(P.params),
fa=v(P.viewModelFactory),ca=v(P.createViewFunction),S=v(P.cacheKey),ga=v(P.lifecycleListener),U=v(P.animation));var v=e(ga,"activated",[s,q]),ia,aa,ba=null==S?null:B[S];if(null!=ba)delete B[S],ia=Promise.resolve(ba.view),aa=Promise.resolve(ba.En);else if(null!=fa&&(aa=g.ignoreDependencies(fa.createViewModel,fa,[Z,q])),null==aa&&null!=R&&(aa=r(a.$z.sd.modelPath+R)),null!=aa&&(aa=aa.then(function(a,b){x(a);return b="function"===typeof b?new b(Z):f(b,"initializeMethod",[s,q])||b}.bind(null,F)),null!=
ca&&(ia=aa.then(function(a,b){x(a);if(null==b)throw z(),"createViewFunction option cannot be used when the ViewModel is null";var c=b[ca];if(null==c)throw z(),"function specified by the createViewFunction option was not found on the ViewModel";return c.call(b)}.bind(null,F)))),null==ia)if(V=null==V?R:V,null!=V)ia=r(a.$z.sd.viewPath+V+a.$z.sd.viewSuffix);else throw z(),Error("View name must be specified");if(null==ia)throw z(),Error("ojModule is missing a View");var W;null!=aa&&(W=aa.then(function(a,
b){x(a);return f(b,"activatedHandler",[s,q])}.bind(null,F)));Promise.all([ia,aa,v,W,D]).then(function(r,v){if(r==F){var x=v[0];if(null==x)throw z(),"The module's View was resolved to null";var I=t(x,z),E=v[1],N=!1,O,na=h(s,K,C),qa=k(s,K);null!=J&&(N=!0,O=na,K||(K=document.createElement("div"),K.className="oj-helper-module-cache",g.virtualElements.prepend(s,K)));var oa=!1,x=function(c){oa||(oa=!0,N?d(na,K):qa.forEach(function(a){g.cleanNode(a)}),b(s,c||s,K),u||(e(ga,"detached",[s,q,A,O]),f(A,"detachedHandler",
[s,q,O]),e(ga,"deactivated",[s,q,A]),f(A,"deactivatedHandler",[s,q])),N?(p(O,a.Components?a.Components.ew:null),B[J]={En:A,view:O}):y(A),A=E,J=S)},Q=function(b){b=b||s;m(b,I);var c=null!=ba;c&&p(I,a.Components?a.Components.xt:null);e(ga,"attached",[b,q,E,c]);f(E,"attachedHandler",[b,q,c]);if(!c){var d=w.createChildContext(E,void 0,function(a){a.$module=E;a.$params=Z});l(I[0],K,function(a){g.applyBindings(d,a)});e(ga,"bindingsApplied",[b,q,E]);f(E,"bindingsAppliedHandler",[b,q])}},ea=function(){e(ga,
"transitionCompleted",[s,q,E]);f(E,"transitionCompletedHandler",[s,q]);z()};if(null!=U){var X=c({node:s,valueAccessor:q,isInitial:u,oldViewModel:A,newViewModel:E},U,s,na,Q,x,ea);D=n(X)}else D=void 0;D||(x(null),Q(null),ea())}}.bind(null,F),function(b,c){c!==E&&null!=c&&(z(),a.F.error(c))}.bind(null,F))},null,{disposeWhenNodeIsRemoved:s});return{controlsDescendantBindings:!0}}};g.virtualElements.allowedBindings.ojModule=!0})()});